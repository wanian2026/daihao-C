# 交易价值过滤参数调整指南

## 概述

交易价值过滤器（WorthTradingFilter）是策略的**第二层过滤机制**，用于判断市场波动是否足以覆盖交易成本，确保只执行"值得交易"的机会。

---

## 参数详解

### 1. `min_rr_ratio` - 最小盈亏比

**含义**：预期盈利与风险的最小比例

**默认值**：`2.0`（即 2:1）

**作用**：
- 确保每笔交易的潜在收益至少是风险的 2 倍
- 盈亏比 = （预期盈利）÷（止损距离）
- 例如：止损 50 USDT，则止盈至少 100 USDT

**调整建议**：

| 策略类型 | 推荐值 | 说明 |
|---------|--------|------|
| **保守型** | 2.5 - 3.0 | 只交易高质量机会，交易频率低但胜率高 |
| **平衡型**（默认） | 1.8 - 2.0 | 平衡机会数量和质量 |
| **激进型** | 1.5 - 1.8 | 追求更多交易机会，风险略高 |

**示例**：
```python
# 保守策略：只交易盈亏比 ≥ 2.5 的机会
min_rr_ratio = 2.5

# 平衡策略：盈亏比 ≥ 2.0
min_rr_ratio = 2.0  # 默认值

# 激进策略：盈亏比 ≥ 1.5
min_rr_ratio = 1.5
```

---

### 2. `min_expected_move` - 最小预期波动

**含义**：市场预期波动的最小百分比

**默认值**：`0.005`（即 0.5%）

**作用**：
- 过滤掉市场波动太小的情况
- 确保市场有足够的波动空间
- 通常基于 ATR（平均真实波幅）计算

**调整建议**：

| 市场环境 | 推荐值 | 说明 |
|---------|--------|------|
| **高波动市场** | 0.006 - 0.008 | 提高门槛，过滤噪音波动 |
| **正常市场**（默认） | 0.004 - 0.005 | 平衡过滤和机会 |
| **低波动市场** | 0.003 - 0.004 | 降低门槛，增加交易机会 |

**示例**：
```python
# 高波动市场：要求波动 ≥ 0.8%
min_expected_move = 0.008

# 正常市场：要求波动 ≥ 0.5%
min_expected_move = 0.005  # 默认值

# 低波动市场：要求波动 ≥ 0.3%
min_expected_move = 0.003
```

---

### 3. `cost_multiplier` - 成本倍数

**含义**：预期波动必须大于交易成本的多少倍

**默认值**：`2.0`

**作用**：
- 确保交易盈利空间足够覆盖成本
- 交易成本包括：手续费、点差、滑点
- 公式：`预期波动 > 交易成本 × 成本倍数`

**交易成本构成**：
```
交易成本 = taker_fee × 2 + spread_cost + slippage
        = 0.05% × 2 + 点差 + 0.05%
        ≈ 0.15% - 0.20%（取决于点差）
```

**调整建议**：

| 策略类型 | 推荐值 | 说明 |
|---------|--------|------|
| **保守型** | 2.5 - 3.0 | 要求更高的盈利空间 |
| **平衡型**（默认） | 2.0 | 确保盈亏平衡 |
| **激进型** | 1.5 - 1.8 | 接受较小的盈利空间 |

**示例**：
```python
# 保守策略：预期波动必须是成本的 3 倍
cost_multiplier = 3.0

# 平衡策略：预期波动必须是成本的 2 倍
cost_multiplier = 2.0  # 默认值

# 激进策略：预期波动必须是成本的 1.5 倍
cost_multiplier = 1.5
```

---

### 4. `min_atr_ratio` - 最小 ATR 比例

**含义**：ATR（平均真实波幅）占当前价格的最小比例

**默认值**：`0.01`（即 1.0%）

**作用**：
- 衡量市场活跃度
- ATR 比例高 = 市场波动大，交易机会多
- ATR 比例低 = 市场波动小，交易机会少

**调整建议**：

| 市场状态 | 推荐值 | 说明 |
|---------|--------|------|
| **活跃市场** | 0.012 - 0.015 | 要求更高的市场活跃度 |
| **正常市场**（默认） | 0.008 - 0.01 | 平衡市场 |
| **休眠市场** | 0.006 - 0.008 | 降低要求，避免完全停止交易 |

**示例**：
```python
# 活跃市场：要求 ATR ≥ 1.5%
min_atr_ratio = 0.015

# 正常市场：要求 ATR ≥ 1.0%
min_atr_ratio = 0.01  # 默认值

# 休眠市场：要求 ATR ≥ 0.8%
min_atr_ratio = 0.008
```

---

## 如何调整参数

### 方法 1：通过 GUI 界面调整（推荐）

1. 启动程序：`python3 eth_fakeout_gui.py`
2. 切换到 **"⚙️ 参数配置"** 标签页
3. 找到 **"交易价值过滤"** 部分
4. 修改参数值
5. 点击 **"💾 保存并应用"** 按钮

参数会实时应用到运行中的系统，无需重启！

### 方法 2：通过代码修改

编辑 `parameter_config.py` 文件：

```python
@dataclass
class WorthTradingFilterConfig:
    """交易价值过滤参数"""
    min_rr_ratio: float = 2.0                # 修改这里
    min_expected_move: float = 0.005         # 修改这里
    cost_multiplier: float = 2.0             # 修改这里
    min_atr_ratio: float = 0.01               # 修改这里
```

### 方法 3：运行时动态调整

```python
from parameter_config import get_config

# 获取配置
config = get_config()

# 调整参数
config.worth_trading_filter.min_rr_ratio = 1.8
config.worth_trading_filter.min_expected_move = 0.004

# 应用到策略系统（如果正在运行）
if strategy_system:
    strategy_system.update_parameters(config.to_dict())
```

---

## 参数组合建议

### 🎯 保守型策略（追求高胜率）

适合：新手、小资金、风险厌恶型用户

```python
min_rr_ratio = 2.5          # 高盈亏比
min_expected_move = 0.006   # 高波动要求
cost_multiplier = 2.5      # 高成本倍数
min_atr_ratio = 0.012      # 高活跃度要求
```

**预期效果**：
- 交易频率：低（每天 3-5 笔）
- 胜率：高（60%-70%）
- 盈亏比：高（2.5:1）
- 最大回撤：小（<5%）

---

### ⚖️ 平衡型策略（默认配置）

适合：有经验的交易者、中等风险承受能力

```python
min_rr_ratio = 2.0          # 中等盈亏比
min_expected_move = 0.005   # 中等波动要求
cost_multiplier = 2.0      # 中等成本倍数
min_atr_ratio = 0.01       # 中等活跃度要求
```

**预期效果**：
- 交易频率：中等（每天 8-12 笔）
- 胜率：中等（50%-60%）
- 盈亏比：中等（2:1）
- 最大回撤：中等（5%-8%）

---

### 🚀 激进型策略（追求高收益）

适合：有丰富经验、高风险承受能力、大资金

```python
min_rr_ratio = 1.5          # 低盈亏比
min_expected_move = 0.003   # 低波动要求
cost_multiplier = 1.5      # 低成本倍数
min_atr_ratio = 0.006      # 低活跃度要求
```

**预期效果**：
- 交易频率：高（每天 15-20 笔）
- 胜率：低（40%-50%）
- 盈亏比：低（1.5:1）
- 最大回撤：大（8%-15%）

---

## 实际测试示例

### 测试 1：检查 ETHUSDT 是否值得交易

```python
from worth_trading_filter import WorthTradingFilter
from binance_api_client import BinanceAPIClient
from data_fetcher import DataFetcher

# 初始化
client = BinanceAPIClient()
fetcher = DataFetcher(client)
filter_engine = WorthTradingFilter(fetcher)

# 检查 ETHUSDT
result = filter_engine.check("ETHUSDT")

print(f"值得交易: {result.is_worth_trading}")
print(f"预期波动: {result.expected_move*100:.2f}%")
print(f"交易成本: {result.total_cost*100:.3f}%")
print(f"盈亏比: {result.risk_reward_ratio:.2f}")
print(f"最小止盈: {result.min_profit_target*100:.2f}%")
print(f"最小止损: {result.min_stop_loss*100:.2f}%")
print(f"原因: {', '.join(result.reasons)}")
```

**示例输出**：
```
值得交易: True
预期波动: 0.85%
交易成本: 0.150%
盈亏比: 2.35
最小止盈: 1.00%
最小止损: 0.43%
原因: 
```

---

## 常见问题

### Q1：如何知道参数是否合适？

**A**：建议在模拟模式下运行 1-2 周，观察以下指标：

1. **交易频率**：每天 5-15 笔比较合理
2. **胜率**：50%-60% 较为理想
3. **盈亏比**：≥ 2.0 比较健康
4. **最大回撤**：≤ 10% 可接受

如果交易太少，适当放宽参数；如果交易太多，适当收紧参数。

---

### Q2：不同市场环境是否需要调整参数？

**A**：是的，建议根据市场环境动态调整：

| 市场状态 | 调整方向 |
|---------|---------|
| 牛市（高波动） | 适当收紧，避免追高 |
| 熊市（低波动） | 适当放宽，增加机会 |
| 震荡市 | 保持默认平衡配置 |
| 重大事件期间 | 收紧参数，降低风险 |

---

### Q3：如何快速验证参数效果？

**A**：使用以下测试脚本：

```bash
python3 test_complete_functionality.py
```

测试脚本会：
- 检查多个合约的交易价值
- 显示每个合约的盈亏比、预期波动、交易成本
- 帮助你快速判断参数是否合理

---

### Q4：参数调整后立即生效吗？

**A**：
- **通过 GUI 调整**：立即生效，无需重启
- **通过代码修改**：需要重启程序
- **通过动态调整**：立即生效（推荐）

---

## 风险提示

1. **激进参数 ≠ 高收益**：过度放宽参数可能导致频繁交易，增加交易成本
2. **保守参数 ≠ 低风险**：过于严格的参数可能错过优质机会
3. **回测很重要**：实盘前务必在模拟模式下充分测试
4. **实时监控**：调整参数后密切观察 1-2 周，确保效果符合预期

---

## 总结

交易价值过滤是策略的核心防护机制，合理调整参数可以：

✅ 提高交易质量
✅ 减少无效交易
✅ 优化盈亏比
✅ 控制风险

**关键原则**：
- 从平衡型开始，根据实际效果微调
- 模拟模式充分测试后再实盘
- 监控效果，及时调整
- 不要一次性调整多个参数

如有问题，可查看日志中的"不值得交易"原因，帮助定位问题！
