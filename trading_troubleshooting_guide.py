#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
自动交易故障排查指南
为什么发现了信号但没有执行交易？
"""

print("""
================================================================================
  自动交易故障排查指南 - 为什么发现了信号但没有执行交易？
================================================================================

## 常见原因和解决方案

### 1. 执行闸门拒绝了交易
**可能原因：**
  a) 持仓已达上限（默认3个）
  b) 距离上次交易时间不足10分钟
  c) K线实体过小（<30%）
  d) 止损距离过小（<1%）

**解决方案：**
  - 查看日志中是否有 "执行闸门拒绝" 消息
  - 检查当前持仓数量
  - 等待交易间隔过去
  - 或者调整参数：max_positions, min_trade_interval_minutes

### 2. 风险管理器阻止了交易
**可能原因：**
  a) 熔断状态已触发
     - 最大回撤达到5%
     - 连续亏损3次
     - 每日亏损达到30U

**解决方案：**
  - 查看日志中是否有 "熔断检查拒绝" 消息
  - 检查风险管理指标面板
  - 等待30分钟自动恢复
  - 或手动重置熔断：在GUI中点击"重置熔断"按钮

### 3. 信号置信度低于阈值
**可能原因：**
  - 信号置信度 < 60%（默认阈值）

**解决方案：**
  - 查看日志中是否有 "未找到置信度 >= 60% 的信号" 消息
  - 可以临时降低置信度阈值（不推荐）
  - 或者等待更高置信度的信号

### 4. 模拟模式已启用
**可能原因：**
  - GUI中的"模拟模式"复选框已勾选
  - 系统不会实际下单，只显示信号

**解决方案：**
  - 取消勾选"模拟模式"复选框
  - 确保API密钥已正确配置

### 5. API连接问题
**可能原因：**
  - API密钥未配置或无效
  - 网络连接问题
  - 币安API服务器问题

**解决方案：**
  - 检查API密钥配置
  - 测试连接：ping 币安服务器
  - 查看日志中的错误信息

### 6. 市场状态过滤
**可能原因：**
  - 市场状态为 SLEEP（不适合交易）
  - 交易价值评估未通过

**解决方案：**
  - 查看日志中是否有 "市场睡眠" 或 "交易价值不足" 消息
  - 等待市场状态变化
  - 或者调整交易价值过滤参数

## 快速检查清单

1. 查看系统实时日志
   - 寻找以下关键词：
     * "执行闸门拒绝"
     * "熔断检查拒绝"
     * "未找到置信度"
     * "市场睡眠"
     * "交易价值不足"
     * "下单失败"

2. 检查风险管理面板
   - 当前余额
   - 总盈亏
   - 连续亏损次数
   - 最大回撤
   - 每日盈亏
   - 熔断状态

3. 检查持仓管理面板
   - 当前持仓数量（3/3 表示已满）
   - 每个持仓的详情

4. 检查系统状态
   - 系统状态：RUNNING / PAUSED / STOPPED
   - 选中的标的列表

5. 检查信号面板
   - 最新发现的信号
   - 信号置信度
   - 入场价、止损价、止盈价

## 调试步骤

1. 启用详细日志
   - 在GUI中查看"系统日志"标签页

2. 手动测试下单
   - 在GUI中使用"手动开仓"功能
   - 检查是否能成功下单

3. 检查参数配置
   - 确认风险参数是否合理
   - 确认执行闸门参数是否合适

4. 临时禁用某些过滤
   - 仅用于调试目的，不建议在生产环境使用
   - 可以临时提高置信度阈值
   - 可以临时增加最大持仓数

## 常见错误信息及含义

"熔断检查拒绝: 熔断状态，剩余 20.0 分钟"
  -> 风险管理器已触发熔断，等待20分钟自动恢复

"执行闸门拒绝: 持仓已达上限 3"
  -> 当前已有3个持仓，无法开新仓
  -> 等待现有持仓平仓，或手动平仓

"执行闸门拒绝: 交易间隔不足，还需 300 秒"
  -> 距离上次交易不足10分钟
  -> 等待剩余时间

"未找到置信度 >= 60% 的信号"
  -> 虽然发现了信号，但置信度都低于60%
  -> 等待更高质量的信号

"下单失败: Insufficient balance"
  -> 账户余额不足
  -> 检查账户资金

"下单失败: API key invalid"
  -> API密钥无效或未配置
  -> 重新配置API密钥

## 暂时解决方案（不推荐长期使用）

如果需要立即测试交易功能，可以临时调整：

1. 重置熔断
   - 在GUI中点击"重置熔断"按钮

2. 增加最大持仓数
   - 在参数配置中将 max_positions 从 3 改为 5

3. 降低置信度阈值
   - 将 min_signal_confidence 从 0.6 改为 0.5

4. 缩短交易间隔
   - 将 min_trade_interval_minutes 从 10 改为 5

⚠️ 注意：这些调整会增加风险，仅用于测试！
⚠️ 实盘交易前请恢复到安全参数！

## 联系支持

如果以上方法都无法解决问题：
1. 收集系统日志
2. 记录错误信息
3. 记录当前系统状态
4. 记录参数配置
5. 提供详细的复现步骤

================================================================================
""")
